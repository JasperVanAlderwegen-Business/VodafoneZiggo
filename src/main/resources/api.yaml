openapi: 3.0.3
info:
  title: Orders API
  version: 1.0.0
  description: Contract-first microservice for creating and listing orders.

servers:
  - url: http://localhost:8080

tags:
  - name: Orders
    description: Order operations

paths:
  /api/orders:
    post:
      tags: [ Orders ]
      summary: Create an order
      description: |
        Creates an order for a given productID and email.
        The service validates that the email exists in https://reqres.in/api/users and that the same customer
        has not already ordered the same product.
      operationId: createOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateOrderRequest"
            examples:
              default:
                value:
                  productID: "1234"
                  email: "abc@def.com"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateOrderResponse"
              examples:
                default:
                  value:
                    orderID: "1234"
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "502":
          $ref: "#/components/responses/BadGateway"

    get:
      tags: [ Orders ]
      summary: Retrieve all orders (optionally filtered by email)
      description: Returns all stored orders. If email is provided, results are filtered by that email.
      operationId: listOrders
      parameters:
        - name: email
          in: query
          required: false
          description: Optional customer email used to filter orders.
          schema:
            type: string
            format: email
          example: "abc@def.com"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "502":
          $ref: "#/components/responses/BadGateway"

  /api/orders/{orderID}:
    delete:
      tags: [ Orders ]
      summary: Delete an order
      description: Deletes a specific order by ID.
      operationId: deleteOrder
      parameters:
        - name: orderID
          in: path
          required: true
          description: Order identifier
          schema:
            type: integer
          example: 1
      responses:
        "204":
          description: No Content - Order deleted successfully
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      tags: [ Orders ]
      summary: Update order owner
      description: Transfers an order to a new user by updating the email and associated user details (first_name, last_name).
      operationId: updateOrder
      parameters:
        - name: orderID
          in: path
          required: true
          description: Order identifier
          schema:
            type: integer
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UpdateOrderRequest"
            examples:
              default:
                value:
                  email: "janet.weaver@reqres.in"
      responses:
        "200":
          description: OK - Order updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
components:
  responses:
    BadRequest:
      description: Request validation failed (e.g., invalid email, missing fields).
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            invalidEmail:
              value:
                code: "VALIDATION_ERROR"
                message: "Invalid request"
                details:
                  - "email must be a well-formed email address"
    Conflict:
      description: The customer already ordered the same product.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            duplicate:
              value:
                code: "DUPLICATE_ORDER"
                message: "Customer has already ordered this product"
                details:
                  - "email=abc@def.com productID=1234"
    BadGateway:
      description: External dependency failure (e.g., reqres.in not reachable).
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            reqresDown:
              value:
                code: "EXTERNAL_SERVICE_ERROR"
                message: "Failed to validate email against external service"
                details:
                  - "reqres.in unavailable or returned unexpected response"
    NotFound:
      description: Order not found or does not belong to the specified email.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          examples:
            notFound:
              value:
                code: "NOT_FOUND"
                message: "Order not found"
                details:
                  - "Order with ID 999 does not exist or does not belong to this user"
  schemas:
    CreateOrderRequest:
      type: object
      additionalProperties: false
      required: [ productID, email ]
      properties:
        productID:
          type: integer
          minLength: 1
          description: Product identifier.
          example: "1234"
        email:
          type: string
          format: email
          description: Customer email address that must exist in reqres.in users.
          example: "abc@def.com"

    UpdateOrderRequest:
      type: object
      additionalProperties: false
      required: [ email ]
      properties:
        email:
          type: string
          format: email
          description: New customer email that must exist in reqres.in users.
          example: "janet.weaver@reqres.in"

    CreateOrderResponse:
      type: object
      additionalProperties: false
      required: [ orderID ]
      properties:
        orderID:
          type: integer
          description: Generated order identifier.
          example: "123"

    Order:
      type: object
      additionalProperties: false
      required: [ orderID, email, first_name, last_name, productID ]
      properties:
        orderID:
          type: string
          description: Order identifier.
        email:
          type: string
          format: email
        first_name:
          type: string
          minLength: 1
        last_name:
          type: string
          minLength: 1
        productID:
          type: string
          minLength: 1

    OrderListResponse:
      type: array
      items:
        $ref: "#/components/schemas/Order"

    ErrorResponse:
      type: object
      additionalProperties: false
      required: [ code, message ]
      properties:
        code:
          type: string
          description: Machine-readable error code.
        message:
          type: string
          description: Human-readable error message.
        details:
          type: array
          description: Optional list of details to help debugging/clients.
          items:
            type: string